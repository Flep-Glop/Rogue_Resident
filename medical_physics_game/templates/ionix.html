<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ionix - The Sentient Ion Chamber</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Core styles for the page */
        body {
            margin: 0;
            padding: 0;
            background-color: #21232d;
            color: #d4dae0;
            font-family: 'Press Start 2P', monospace, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(to bottom, rgba(45, 23, 53, 0.95), rgba(25, 12, 30, 0.98));
        }

        /* Radial glow background effect */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255, 106, 0, 0.2) 0%, rgba(0, 0, 0, 0) 70%);
            z-index: -1;
            animation: pulse-subtle 4s infinite alternate ease-in-out;
        }

        /* Main container holding Ionix */
        .ionix-container {
            width: 90vw;
            height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 106, 0, 0.6);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Title styling */
        .ionix-title {
            color: #ff6a00;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 106, 0, 0.7);
            text-align: center;
            position: relative;
            z-index: 10;
        }

        /* Subtitle styling */
        .ionix-subtitle {
            color: #ff9d4c;
            font-size: 1.2rem;
            margin-bottom: 40px;
            text-shadow: 0 0 10px rgba(255, 106, 0, 0.5);
            text-align: center;
            position: relative;
            z-index: 10;
        }

        /* Character display area */
        .ionix-display {
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 5;
            margin-bottom: 20px;
        }

        /* The sprite container */
        #ionix-sprite-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Control panel */
        .control-panel {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
        }

        .anim-btn {
            background: linear-gradient(to bottom, #ff8f30, #e55b00);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-family: 'Press Start 2P', monospace, sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .anim-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(to bottom, #ffaa30, #ff6a00);
        }

        .anim-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .anim-btn.active {
            background: linear-gradient(to bottom, #e55b00, #cc5000);
            box-shadow: 0 0 15px rgba(255, 106, 0, 0.6), inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* Glow effects around Ionix */
        .ionix-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 106, 0, 0.5) 0%, rgba(255, 106, 0, 0.2) 40%, rgba(255, 106, 0, 0) 70%);
            filter: blur(30px);
            opacity: 0.8;
            z-index: 2;
            animation: glow-pulse 4s infinite alternate ease-in-out;
            pointer-events: none;
        }

        /* Floating particles in background */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(255, 106, 0, 0.6);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.6;
            filter: blur(2px);
            animation: float-up 15s infinite linear;
        }

        /* Dialog box */
        .ionix-dialog {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #ff6a00;
            font-size: 1.2rem;
            line-height: 1.5;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            z-index: 20;
            display: none;
        }

        /* Back to Main button */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: #ff9d4c;
            border: 2px solid #ff6a00;
            border-radius: 5px;
            padding: 10px 15px;
            font-family: 'Press Start 2P', monospace, sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 106, 0, 0.3);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes pulse-subtle {
            0% { opacity: 0.5; }
            100% { opacity: 0.8; }
        }

        @keyframes glow-pulse {
            0% { opacity: 0.6; transform: scale(0.9); }
            100% { opacity: 0.9; transform: scale(1.1); }
        }

        @keyframes float-up {
            0% {
                transform: translateY(100%) translateX(0) rotate(0deg);
                opacity: 0.7;
            }
            100% {
                transform: translateY(-100%) translateX(var(--x-drift)) rotate(var(--rotation));
                opacity: 0;
            }
        }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            .ionix-title {
                font-size: 1.5rem;
            }
            
            .ionix-subtitle {
                font-size: 0.8rem;
            }
            
            .control-panel {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .anim-btn {
                padding: 10px 15px;
                font-size: 0.8rem;
            }
            
            .ionix-dialog {
                font-size: 0.9rem;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-btn">‚Üê Back to Main</a>
    
    <div class="ionix-container">
        <h1 class="ionix-title">IONIX</h1>
        <h2 class="ionix-subtitle">The Sentient Ion Chamber</h2>
        
        <div class="ionix-display">
            <div class="ionix-glow"></div>
            <div id="ionix-sprite-container"></div>
        </div>
        
        <div class="control-panel">
            <button class="anim-btn active" id="idle-btn">Idle</button>
            <button class="anim-btn" id="ability-btn">Ability</button>
            <button class="anim-btn" id="walking-btn">Walking</button>
            <button class="anim-btn" id="special-btn">Special Ability</button>
            <button class="anim-btn" id="dialog-btn">Toggle Dialog</button>
        </div>
        
        <div class="ionix-dialog" id="ionix-dialog">
            "Welcome to your Radiation Metrology examination. I am Professor Ionix, a sentient ion chamber. Let's see if your understanding of medical physics is... ionizing enough."
        </div>
        
        <div class="particles" id="particles-container"></div>
    </div>

    <!-- Import sprite animation systems -->
    <script src="/static/js/sprite-system/canvas-sprite-animator.js"></script>
    <script src="/static/js/sprite-system/sprite-system.js"></script>
    <script src="/static/js/npc_assets.js"></script>

    <script>
        // Animation controller
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const spriteContainer = document.getElementById('ionix-sprite-container');
            const idleBtn = document.getElementById('idle-btn');
            const abilityBtn = document.getElementById('ability-btn');
            const walkingBtn = document.getElementById('walking-btn');
            const specialBtn = document.getElementById('special-btn');
            const dialogBtn = document.getElementById('dialog-btn');
            const dialogBox = document.getElementById('ionix-dialog');
            
            // Animation state
            let currentAnimationId = null;
            let currentAnimation = 'idle';
            
            // Dialog quotes (from npc_assets.js if available, or fallback)
            let dialogQuotes = [
                "Welcome to your Radiation Metrology examination. I am Professor Ionix, a sentient ion chamber.",
                "As a sentient ion chamber, I have the unique ability to measure your knowledge directly.",
                "Let's see if your understanding of medical physics is... ionizing enough.",
                "Your answer is highly charged with accuracy!",
                "Correct! Your knowledge shows no signs of recombination.",
                "Yes! You've collected the right electrons from your memory.",
                "Hmm, there seems to be saturation in your reasoning.",
                "Incorrect. Your answer lacks proper calibration.",
                "Let's increase the potential and move to the next section.",
                "Now we'll probe your knowledge with higher energy questions.",
                "Your confidence shows good linearity so far. Let's test its limits.",
                "Excellent! Your performance shows proportional region precision. You'll make a fine medical physicist."
            ];
            
            // If NPCAssets is loaded and has dialogue for ionChamberBoss, use it
            if (window.NPCAssets && NPCAssets.npcs && NPCAssets.npcs.ionChamberBoss && NPCAssets.npcs.ionChamberBoss.dialogue) {
                const bossDialogue = NPCAssets.npcs.ionChamberBoss.dialogue;
                dialogQuotes = [
                    ...bossDialogue.intro,
                    ...bossDialogue.correct,
                    ...bossDialogue.incorrect,
                    ...bossDialogue.phase_transition,
                    bossDialogue.completion.success,
                    bossDialogue.completion.failure
                ];
            }
            
            // Initialize sprite animation
            function initializeAnimation() {
                // Make sure required scripts are loaded
                if (!window.SpriteSystem || !window.CanvasSpriteAnimator || !window.NPCAssets) {
                    console.error("Required animation scripts not loaded!");
                    displayFallbackImage();
                    return;
                }
                
                // Create animation
                createIonixAnimation('idle');
                
                // Set up button handlers
                setupButtonHandlers();
            }
            
            // Create Ionix animation
            function createIonixAnimation(animationName) {
                // Clear any existing animation
                if (currentAnimationId) {
                    SpriteSystem.removeAnimation(currentAnimationId);
                    currentAnimationId = null;
                }
                
                // Create new animation
                const options = {
                    animation: animationName,
                    scale: 5,
                    autoPlay: true,
                    loop: animationName === 'idle' || animationName === 'walking'
                };
                
                // If not using idle/walking, add completion handler to revert to idle
                if (animationName !== 'idle' && animationName !== 'walking') {
                    options.onComplete = function() {
                        // Auto-reset to idle after animation completes
                        setTimeout(() => {
                            setActiveAnimation('idle');
                        }, 100);
                    };
                }
                
                // Create the animation
                currentAnimationId = SpriteSystem.createAnimation(
                    'ionChamberBoss',
                    spriteContainer,
                    options
                );
                
                // If animation creation failed, try direct animator
                if (!currentAnimationId) {
                    createDirectAnimation(animationName);
                }
                
                // Update current animation
                currentAnimation = animationName;
                
                // Update button states
                updateButtonStates();
            }
            
            // Create animation directly using CanvasSpriteAnimator
            function createDirectAnimation(animationName) {
                if (!window.CanvasSpriteAnimator || !window.NPCAssets) {
                    displayFallbackImage();
                    return;
                }
                
                try {
                    // Clear container
                    spriteContainer.innerHTML = '';
                    
                    // Get animation data from NPCAssets
                    const npc = NPCAssets.npcs.ionChamberBoss;
                    if (!npc || !npc.animations || !npc.animations[animationName]) {
                        throw new Error(`Animation "${animationName}" not found for Ionix`);
                    }
                    
                    const animData = npc.animations[animationName];
                    const spritePath = npc.spritePath + animData.file;
                    
                    // Create animator directly
                    const animator = new CanvasSpriteAnimator({
                        imagePath: spritePath,
                        frameCount: animData.frames || 1,
                        frameWidth: animData.width || 97,
                        frameHeight: animData.height / animData.frames || 97,
                        fps: 1000 / (animData.speed || 150),
                        scale: 5,
                        loop: animationName === 'idle' || animationName === 'walking',
                        autoPlay: true,
                        layout: 'vertical'
                    });
                    
                    // Mount animator
                    animator.mount(spriteContainer);
                    
                    // Store for cleanup
                    window.currentAnimator = animator;
                    
                    // If not idle/walking, add completion handler
                    if (animationName !== 'idle' && animationName !== 'walking') {
                        animator.addEventListener('complete', function() {
                            // Auto-reset to idle after animation completes
                            setTimeout(() => {
                                setActiveAnimation('idle');
                            }, 100);
                        });
                    }
                } catch (error) {
                    console.error("Error creating direct animation:", error);
                    displayFallbackImage();
                }
            }
            
            // Display fallback image if animation fails
            function displayFallbackImage() {
                spriteContainer.innerHTML = `
                    <div style="position: relative; width: 200px; height: 200px; display: flex; justify-content: center; align-items: center;">
                        <div class="ionix-glow"></div>
                        <img src="/static/img/characters/ion_chamber/idle.png" 
                             alt="Ionix" 
                             style="width: 100px; height: 100px; object-fit: contain; image-rendering: pixelated; transform: scale(3);">
                    </div>
                `;
            }
            
            // Set active animation with button update
            function setActiveAnimation(animationName) {
                createIonixAnimation(animationName);
                
                // If this is ability or special, show random dialog
                if (animationName === 'ability' || animationName === 'specialAbility') {
                    showRandomDialog();
                }
            }
            
            // Update button active states
            function updateButtonStates() {
                // Remove active class from all buttons
                document.querySelectorAll('.anim-btn').forEach(btn => btn.classList.remove('active'));
                
                // Set active class on current animation button
                let buttonId;
                switch (currentAnimation) {
                    case 'idle': buttonId = 'idle-btn'; break;
                    case 'ability': buttonId = 'ability-btn'; break;
                    case 'walking': buttonId = 'walking-btn'; break;
                    case 'specialAbility': buttonId = 'special-btn'; break;
                    default: buttonId = 'idle-btn';
                }
                
                const activeButton = document.getElementById(buttonId);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
            
            // Setup button handlers
            function setupButtonHandlers() {
                idleBtn.addEventListener('click', () => setActiveAnimation('idle'));
                abilityBtn.addEventListener('click', () => setActiveAnimation('ability'));
                walkingBtn.addEventListener('click', () => setActiveAnimation('walking'));
                specialBtn.addEventListener('click', () => setActiveAnimation('specialAbility'));
                
                // Dialog toggler
                dialogBtn.addEventListener('click', () => {
                    if (dialogBox.style.display === 'block') {
                        dialogBox.style.display = 'none';
                    } else {
                        dialogBox.style.display = 'block';
                        showRandomDialog();
                    }
                });
            }
            
            // Show random dialog
            function showRandomDialog() {
                if (dialogQuotes.length > 0) {
                    const randomIndex = Math.floor(Math.random() * dialogQuotes.length);
                    dialogBox.textContent = dialogQuotes[randomIndex];
                    dialogBox.style.display = 'block';
                }
            }
            
            // Create floating particles
            function createParticles() {
                const particlesContainer = document.getElementById('particles-container');
                const particleCount = 30;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');
                    
                    // Random position, size and animation delay
                    const size = Math.random() * 6 + 4;
                    const left = Math.random() * 100;
                    const delay = Math.random() * 15;
                    const xDrift = (Math.random() * 200 - 100) + 'px';
                    const rotation = Math.random() * 360 + 'deg';
                    
                    particle.style.width = size + 'px';
                    particle.style.height = size + 'px';
                    particle.style.left = left + '%';
                    particle.style.bottom = '-5%';
                    particle.style.opacity = Math.random() * 0.5 + 0.2;
                    particle.style.animationDelay = delay + 's';
                    particle.style.setProperty('--x-drift', xDrift);
                    particle.style.setProperty('--rotation', rotation);
                    
                    particlesContainer.appendChild(particle);
                }
            }
            
            // Initialize everything
            initializeAnimation();
            createParticles();
        });
    </script>
</body>
</html>