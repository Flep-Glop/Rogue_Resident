{% extends "base.html" %}

{% block title %}Atomic Skill Tree - Medical Physics Game{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/atomic_skill_tree.css') }}">
<style>
  /* Additional styling for the page */
  .skill-tree-page {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .page-header {
    margin-bottom: 20px;
    text-align: center;
  }
  
  .page-header h1 {
    font-size: 28px;
    margin-bottom: 8px;
    color: #ffffff;
    text-shadow: 0 0 10px rgba(70, 130, 180, 0.8);
  }
  
  .page-header p {
    font-size: 16px;
    color: #aabbcc;
    max-width: 700px;
    margin: 0 auto;
  }
  
  .stats-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 16px;
  }
  
  .stat-card {
    background-color: rgba(20, 30, 50, 0.8);
    border: 1px solid #3a4a6a;
    border-radius: 6px;
    padding: 10px 16px;
    min-width: 120px;
    text-align: center;
  }
  
  .stat-label {
    font-size: 12px;
    color: #aabbcc;
    margin-bottom: 4px;
  }
  
  .stat-value {
    font-size: 22px;
    font-weight: bold;
    color: #ffffff;
  }
  
  .specialization-progress {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .spec-progress-item {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .spec-progress-item.theory {
    background-color: rgba(66, 135, 245, 0.2);
  }
  
  .spec-progress-item.clinical {
    background-color: rgba(66, 245, 117, 0.2);
  }
  
  .spec-progress-item.technical {
    background-color: rgba(245, 145, 66, 0.2);
  }
  
  .spec-progress-item.research {
    background-color: rgba(161, 66, 245, 0.2);
  }
  
  .spec-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  
  .spec-indicator.theory {
    background-color: #4287f5;
  }
  
  .spec-indicator.clinical {
    background-color: #42f575;
  }
  
  .spec-indicator.technical {
    background-color: #f59142;
  }
  
  .spec-indicator.research {
    background-color: #a142f5;
  }
  
  .atomic-skill-tree-container {
    margin-bottom: 20px;
    position: relative;
  }
  
  .action-buttons {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
  }
  
  .action-button {
    padding: 8px 16px;
    background-color: rgba(50, 70, 100, 0.8);
    border: 1px solid #3a4a6a;
    border-radius: 4px;
    color: #ffffff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .action-button.primary {
    background-color: rgba(66, 135, 245, 0.3);
    border: 1px solid #4287f5;
  }
  
  .action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }
  
  .action-button.primary:hover {
    background-color: rgba(66, 135, 245, 0.5);
  }
  
  .star-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
  }
  
  .star {
    position: absolute;
    background-color: #ffffff;
    border-radius: 50%;
    width: 2px;
    height: 2px;
    opacity: 0.7;
    animation: twinkle 4s infinite alternate;
  }
  
  @keyframes twinkle {
    0% {
      opacity: 0.3;
      transform: scale(0.8);
    }
    100% {
      opacity: 0.7;
      transform: scale(1);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="star-bg" id="star-bg"></div>

<div class="skill-tree-page">
  <div class="page-header">
    <h1>ATOMIC SKILL TREE</h1>
    <p>Master your medical physics journey through specialized skills and atomic knowledge. Unlock permanent abilities to enhance your capabilities in future runs.</p>
  </div>
  
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-label">REPUTATION</div>
      <div class="stat-value" id="reputation-value">0</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-label">SKILL POINTS</div>
      <div class="stat-value" id="skill-points-value">0</div>
    </div>
  </div>
  
  <div class="specialization-progress">
    <div class="spec-progress-item theory">
      <span class="spec-indicator theory"></span>
      <span>Theory: <span id="theory-progress">0</span></span>
    </div>
    
    <div class="spec-progress-item clinical">
      <span class="spec-indicator clinical"></span>
      <span>Clinical: <span id="clinical-progress">0</span></span>
    </div>
    
    <div class="spec-progress-item technical">
      <span class="spec-indicator technical"></span>
      <span>Technical: <span id="technical-progress">0</span></span>
    </div>
    
    <div class="spec-progress-item research">
      <span class="spec-indicator research"></span>
      <span>Research: <span id="research-progress">0</span></span>
    </div>
  </div>
  
  <div id="skill-tree-controls" class="specialization-filters">
    <!-- Filters will be populated by JavaScript -->
  </div>
  
  <div class="atomic-skill-tree-container">
    <div id="skill-tree-visualization"></div>
    
    <div class="skill-tree-controls">
      <button id="zoom-in-btn" class="canvas-control">+</button>
      <button id="zoom-out-btn" class="canvas-control">-</button>
      <button id="reset-view-btn" class="canvas-control">‚ü≥</button>
    </div>
  </div>
  
  <div id="skill-tree-info" class="skill-info-panel">
    <div class="skill-info-empty">
      <p>Select a node to view details</p>
    </div>
  </div>
  
  <div class="action-buttons">
    <button id="save-progress-btn" class="action-button primary">
      <i class="fas fa-save"></i>
      Save Progress
    </button>
    
    <a href="{{ url_for('game') }}" class="action-button">
      <i class="fas fa-arrow-left"></i>
      Back to Game
    </a>
  </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Generate star background
  generateStarBackground();
  
  // Initialize the skill tree components
  initializeSkillTree();
});

/**
 * Generate star background for visual effect
 */
function generateStarBackground() {
  const starBg = document.getElementById('star-bg');
  if (!starBg) return;
  
  // Clear existing stars
  starBg.innerHTML = '';
  
  // Create stars
  for (let i = 0; i < 100; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    star.style.left = `${Math.random() * 100}%`;
    star.style.top = `${Math.random() * 100}%`;
    star.style.width = `${1 + Math.random() * 2}px`;
    star.style.height = star.style.width;
    star.style.animationDelay = `${Math.random() * 4}s`;
    
    starBg.appendChild(star);
  }
}

/**
 * Initialize skill tree components
 */
function initializeSkillTree() {
  // Check if components are loaded
  if (!window.AtomicSkillTreeRenderer || !window.AtomicSkillTreeController) {
    console.error("Skill tree components not loaded");
    setTimeout(initializeSkillTree, 500);
    return;
  }
  
  // Initialize controller
  if (!window.AtomicSkillTreeController.initialized) {
    window.AtomicSkillTreeController.initialize({
      renderContainerId: 'skill-tree-visualization',
      infoContainerId: 'skill-tree-info',
      controlsContainerId: 'skill-tree-controls'
    });
  }
  
  // Add event listeners for controls
  setupEventListeners();
  
  // Load skill tree data
  loadSkillTreeData();
}

/**
 * Set up event listeners
 */
function setupEventListeners() {
  // Zoom controls
  const zoomInBtn = document.getElementById('zoom-in-btn');
  if (zoomInBtn) {
    zoomInBtn.addEventListener('click', function() {
      window.AtomicSkillTreeController.renderer.zoomCanvas(0.1);
    });
  }
  
  const zoomOutBtn = document.getElementById('zoom-out-btn');
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', function() {
      window.AtomicSkillTreeController.renderer.zoomCanvas(-0.1);
    });
  }
  
  const resetViewBtn = document.getElementById('reset-view-btn');
  if (resetViewBtn) {
    resetViewBtn.addEventListener('click', function() {
      window.AtomicSkillTreeController.renderer.resetView();
    });
  }
  
  // Save progress button
  const saveProgressBtn = document.getElementById('save-progress-btn');
  if (saveProgressBtn) {
    saveProgressBtn.addEventListener('click', function() {
      window.AtomicSkillTreeController.saveProgress()
        .then(() => {
          alert('Progress saved successfully!');
        })
        .catch(error => {
          console.error('Error saving progress:', error);
          alert('Failed to save progress.');
        });
    });
  }
}

/**
 * Load skill tree data from API
 */
function loadSkillTreeData() {
  // Show loading state
  document.getElementById('skill-tree-visualization').innerHTML = `
    <div class="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading skill tree...</div>
    </div>
  `;
  
  // Fetch skill tree data
  fetch('/api/skill-tree')
    .then(response => {
      if (!response.ok) {
        throw new Error(`Failed to load skill tree: ${response.status}`);
      }
      return response.json();
    })
    .then(skillTreeData => {
      // Fetch player progress
      return fetch('/api/skill-progress')
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load progress: ${response.status}`);
          }
          return response.json();
        })
        .then(progressData => {
          // Load data into controller
          window.AtomicSkillTreeController.loadSkillTree(skillTreeData, progressData);
          
          // Update UI with progress data
          updateProgressDisplay(progressData);
        });
    })
    .catch(error => {
      console.error('Error loading skill tree data:', error);
      document.getElementById('skill-tree-visualization').innerHTML = `
        <div class="error-message">
          <h3>Error Loading Skill Tree</h3>
          <p>${error.message}</p>
          <button onclick="loadSkillTreeData()">Try Again</button>
        </div>
      `;
    });
}

/**
 * Update progress display
 * @param {Object} progressData - Player's progress data
 */
function updateProgressDisplay(progressData) {
  // Update reputation
  const repElement = document.getElementById('reputation-value');
  if (repElement) {
    repElement.textContent = progressData.reputation || 0;
  }
  
  // Update skill points
  const pointsElement = document.getElementById('skill-points-value');
  if (pointsElement) {
    pointsElement.textContent = progressData.skill_points_available || 0;
  }
  
  // Update specialization progress
  if (progressData.specialization_progress) {
    Object.entries(progressData.specialization_progress).forEach(([spec, value]) => {
      const element = document.getElementById(`${spec}-progress`);
      if (element) {
        element.textContent = value;
      }
    });
  }
}
</script>

<!-- Import required scripts -->
<script src="{{ url_for('static', filename='js/systems/skill_tree/components/atomic_skill_tree_renderer.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/systems/skill_tree/core/atomic_skill_tree_controller.js') }}" type="module"></script>
{% endblock %}